<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>BGM í…ŒíŠ¸ë¦¬ìŠ¤</title>
<style>
  body {
    background: #111;
    color: #fff;
    display: flex;
    justify-content: center;
    margin-top: 30px;
    font-family: Arial, sans-serif;
    transition: background 0.3s;
  }
  canvas {
    background: #000;
    border: 2px solid #666;
  }
  .panel { margin-left: 20px; }
  .flash { animation: flash 0.15s linear 2; }
  button { margin-top: 10px; width: 100%; }

  @keyframes flash {
    0% { background: #fff; }
    100% { background: #111; }
  }
</style>
</head>
<body id="body">

<canvas id="game" width="240" height="400"></canvas>

<div class="panel">
  <h2>ğŸ® í…ŒíŠ¸ë¦¬ìŠ¤</h2>
  <div>ì ìˆ˜: <span id="score">0</span></div>
  <div>ë ˆë²¨: <span id="level">1</span></div>
  <button id="musicBtn">ğŸ”Š ìŒì•… ON</button>
  <p>â† â†’ ì´ë™</p>
  <p>â†‘ íšŒì „</p>
  <p>â†“ ë¹ ë¥´ê²Œ</p>
</div>

<!-- ğŸµ ë°°ê²½ ìŒì•… -->
<audio id="bgm" src="bgm.mp3" loop></audio>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
ctx.scale(20, 20);

const body = document.getElementById("body");
const scoreEl = document.getElementById("score");
const levelEl = document.getElementById("level");
const bgm = document.getElementById("bgm");
const musicBtn = document.getElementById("musicBtn");

let musicOn = false;

/* ğŸµ ìŒì•… ì œì–´ */
musicBtn.onclick = () => {
  if (musicOn) {
    bgm.pause();
    musicBtn.textContent = "ğŸ”Š ìŒì•… ON";
  } else {
    bgm.play();
    musicBtn.textContent = "ğŸ”‡ ìŒì•… OFF";
  }
  musicOn = !musicOn;
};

const colors = [
  null,
  "#ff595e","#1982c4","#8ac926","#ffca3a",
  "#6a4c93","#ff924c","#4d96ff","#00f5d4"
];

function randomBg() {
  body.style.background =
    `hsl(${Math.random()*360},40%,15%)`;
}

function flash() {
  body.classList.add("flash");
  setTimeout(() => body.classList.remove("flash"), 300);
}

function createMatrix(w, h) {
  return Array.from({length:h}, () => Array(w).fill(0));
}

function createPiece(type) {
  if (type==="T") return [[0,1,0],[1,1,1],[0,0,0]];
  if (type==="O") return [[2,2],[2,2]];
  if (type==="L") return [[0,3,0],[0,3,0],[0,3,3]];
  if (type==="J") return [[0,4,0],[0,4,0],[4,4,0]];
  if (type==="I") return [[0,5,0,0],[0,5,0,0],[0,5,0,0],[0,5,0,0]];
  if (type==="S") return [[0,6,6],[6,6,0],[0,0,0]];
  if (type==="Z") return [[7,7,0],[0,7,7],[0,0,0]];
  if (type==="U") return [[8,0,8],[8,8,8],[0,0,0]];
}

function drawMatrix(matrix, offset) {
  matrix.forEach((row,y)=>{
    row.forEach((value,x)=>{
      if(value){
        ctx.fillStyle = colors[value];
        ctx.fillRect(x+offset.x,y+offset.y,1,1);
      }
    });
  });
}

/* ğŸ”¥ ë°”ë‹¥ ì¶©ëŒ ì •í™• */
function collide(arena, player) {
  for (let y=0;y<player.matrix.length;y++){
    for (let x=0;x<player.matrix[y].length;x++){
      if (
        player.matrix[y][x]!==0 &&
        (arena[y+player.pos.y] &&
         arena[y+player.pos.y][x+player.pos.x])!==0
      ) return true;
    }
  }
  return false;
}

function merge(arena, player) {
  player.matrix.forEach((row,y)=>{
    row.forEach((value,x)=>{
      if(value){
        arena[y+player.pos.y][x+player.pos.x]=value;
      }
    });
  });
}

function rotate(matrix) {
  for (let y=0;y<matrix.length;y++){
    for (let x=0;x<y;x++){
      [matrix[x][y],matrix[y][x]] =
      [matrix[y][x],matrix[x][y]];
    }
  }
  matrix.forEach(row=>row.reverse());
}

function sweep() {
  let lines = 0;
  outer: for (let y=arena.length-1;y>=0;y--){
    for (let x=0;x<arena[y].length;x++){
      if(arena[y][x]===0) continue outer;
    }
    arena.splice(y,1);
    arena.unshift(Array(arena[0].length).fill(0));
    lines++; y++;
  }

  if(lines){
    score += lines*100;
    level = Math.floor(score/500)+1;
    dropInterval = Math.max(150,800-level*70);
    randomBg();
    flash();
    updateUI();
  }
}

function playerDrop() {
  player.pos.y++;
  if (collide(arena,player)){
    player.pos.y--;
    merge(arena,player);
    resetPlayer();
    sweep();
  }
  dropCounter = 0;
}

function playerMove(dir) {
  player.pos.x += dir;
  if (collide(arena,player)) player.pos.x -= dir;
}

function playerRotate() {
  const pos = player.pos.x;
  rotate(player.matrix);
  let offset = 1;
  while (collide(arena,player)){
    player.pos.x += offset;
    offset = -(offset+(offset>0?1:-1));
    if (offset > player.matrix[0].length){
      rotate(player.matrix);
      rotate(player.matrix);
      rotate(player.matrix);
      player.pos.x = pos;
      return;
    }
  }
}

function resetPlayer() {
  const pieces = "ILJOTSZU";
  player.matrix = createPiece(
    pieces[Math.random()*pieces.length|0]
  );
  player.pos.y = 0;
  player.pos.x =
    (arena[0].length/2|0) -
    (player.matrix[0].length/2|0);

  if (collide(arena,player)){
    arena.forEach(row=>row.fill(0));
    score=0; level=1; dropInterval=800;
    updateUI();
  }
}

function updateUI() {
  scoreEl.textContent = score;
  levelEl.textContent = level;
}

let score=0, level=1;
let dropCounter=0, dropInterval=800, lastTime=0;

function update(time=0) {
  const delta=time-lastTime;
  lastTime=time;
  dropCounter+=delta;
  if (dropCounter>dropInterval) playerDrop();

  ctx.fillStyle="#000";
  ctx.fillRect(0,0,canvas.width,canvas.height);
  drawMatrix(arena,{x:0,y:0});
  drawMatrix(player.matrix,player.pos);
  requestAnimationFrame(update);
}

const arena=createMatrix(12,20);
const player={pos:{x:0,y:0},matrix:null};

document.addEventListener("keydown",e=>{
  if(!musicOn){ bgm.play(); musicOn=true; musicBtn.textContent="ğŸ”‡ ìŒì•… OFF"; }
  if(e.key==="ArrowLeft") playerMove(-1);
  if(e.key==="ArrowRight") playerMove(1);
  if(e.key==="ArrowDown") playerDrop();
  if(e.key==="ArrowUp") playerRotate();
});

resetPlayer();
updateUI();
update();
</script>
</body>
</html>
